<!--

    Copyright 2015 Red Hat, Inc. and/or its affiliates
    and other contributors as indicated by the @author tags.

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<subsystem xmlns="urn:org.hawkular.agent.monitor:monitor:1.0"
           enabled="true"
           apiJndiName="java:global/hawkular/agent/monitor/api"
           numMetricSchedulerThreads="3"
           numAvailSchedulerThreads="3">

  <storage-adapter type="HAWKULAR"
                   url="http://localhost:8080"
                   context="/hawkular-bus/message/"
                   restContext="/hawkular-metrics/" />

  <diagnostics enabled="true"
               reportTo="LOG"
               interval="1"
               timeUnits="minutes"/>

  <metric-set-dmr name="WildFly Memory Metrics" enabled="true">
    <metric-dmr name="Heap Used"
                interval="30"
                timeUnits="seconds"
                path="/core-service=platform-mbean/type=memory"
                attribute="heap-memory-usage#used" />

    <metric-dmr name="Heap Committed"
                interval="1"
                timeUnits="minutes"
                path="/core-service=platform-mbean/type=memory"
                attribute="heap-memory-usage#committed" />

    <metric-dmr name="NonHeap Used"
                interval="30"
                timeUnits="seconds"
                path="/core-service=platform-mbean/type=memory"
                attribute="non-heap-memory-usage#used" />

    <metric-dmr name="NonHeap Committed"
                interval="1"
                timeUnits="minutes"
                path="/core-service=platform-mbean/type=memory"
                attribute="non-heap-memory-usage#committed" />
  </metric-set-dmr>

  <metric-set-dmr name="WildFly Threading Metrics" enabled="true">
    <metric-dmr name="Thread Count"
                interval="2"
                timeUnits="minutes"
                path="/core-service=platform-mbean/type=threading"
                attribute="thread-count" />
  </metric-set-dmr>

  <metric-set-dmr name="Undertow Metrics" enabled="true">
    <metric-dmr name="Active Sessions"
                interval="2"
                timeUnits="minutes"
                path="/subsystem=undertow"
                attribute="active-sessions" />

    <metric-dmr name="Sessions Created"
                interval="2"
                timeUnits="minutes"
                path="/subsystem=undertow"
                attribute="sessions-created" />
  </metric-set-dmr>

  <metric-set-dmr name="Servlet Metrics" enabled="true">
    <metric-dmr name="Max Request Time"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="max-request-time" />

    <metric-dmr name="Min Request Time"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="min-request-time" />

    <metric-dmr name="Total Request Time"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="total-request-time" />

    <metric-dmr name="Request Count"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="request-count" />
  </metric-set-dmr>

  <metric-set-dmr name="Singleton EJB Metrics" enabled="true">
    <metric-dmr name="Execution Time"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="execution-time" />

    <metric-dmr name="Invocations"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="invocations" />

    <metric-dmr name="Peak Concurrent Invocations"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="peak-concurrent-invocations" />

    <metric-dmr name="Wait Time"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="wait-time" />
  </metric-set-dmr>

  <metric-set-dmr name="Message Driven EJB Metrics" enabled="true">
    <metric-dmr name="Execution Time"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="execution-time" />

    <metric-dmr name="Invocations"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="invocations" />

    <metric-dmr name="Peak Concurrent Invocations"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="peak-concurrent-invocations" />

    <metric-dmr name="Wait Time"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="wait-time" />

    <metric-dmr name="Pool Availabile Count"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="pool-available-count" />

    <metric-dmr name="Pool Create Count"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="pool-create-count" />

    <metric-dmr name="Pool Current Size"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="pool-current-size" />

    <metric-dmr name="Pool Max Size"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="pool-max-size" />

    <metric-dmr name="Pool Remove Count"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="pool-remove-count" />
  </metric-set-dmr>

  <metric-set-dmr name="Stateless Session EJB Metrics" enabled="true">
    <metric-dmr name="Execution Time"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="execution-time" />

    <metric-dmr name="Invocations"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="invocations" />

    <metric-dmr name="Peak Concurrent Invocations"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="peak-concurrent-invocations" />

    <metric-dmr name="Wait Time"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="wait-time" />

    <metric-dmr name="Pool Availabile Count"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="pool-available-count" />

    <metric-dmr name="Pool Create Count"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="pool-create-count" />

    <metric-dmr name="Pool Current Size"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="pool-current-size" />

    <metric-dmr name="Pool Max Size"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="pool-max-size" />

    <metric-dmr name="Pool Remove Count"
                interval="5"
                timeUnits="minutes"
                path="/"
                attribute="pool-remove-count" />
  </metric-set-dmr>

  <resource-type-set-dmr name="Main" enabled="true">
    <resource-type-dmr name="WildFly Server"
                       path="/"
                       metricSets="WildFly Memory Metrics,WildFly Threading Metrics"
                       availSets="Server Availability" />
  </resource-type-set-dmr>

  <resource-type-set-dmr name="Hawkular" enabled="true">
    <resource-type-dmr name="Bus Broker"
                       path="/subsystem=hawkular-bus-broker"
                       parent="WildFly Server"/>
  </resource-type-set-dmr>

  <resource-type-set-dmr name="Deployment" enabled="true">
    <resource-type-dmr name="Deployment [%2]"
                       path="/deployment=*"
                       parent="WildFly Server"
                       metricSets="Undertow Metrics"
                       availSets="Deployment Status" />

    <resource-type-dmr name="SubDeployment [%2]"
                       path="/subdeployment=*"
                       parent="Deployment"
                       metricSets="Undertow Metrics" />
  </resource-type-set-dmr>

  <resource-type-set-dmr name="Web Component" enabled="true">
    <resource-type-dmr name="Servlet [%4]"
                       path="/subsystem=undertow/servlet=*"
                       parent="Deployment,SubDeployment"
                       metricSets="Servlet Metrics" />
  </resource-type-set-dmr>

  <resource-type-set-dmr name="EJB" enabled="true">
    <resource-type-dmr name="Singleton EJB [%4]"
                       path="/subsystem=ejb3/singleton-bean=*"
                       parent="Deployment,SubDeployment"
                       metricSets="Singleton EJB Metrics" />

    <resource-type-dmr name="Message Driven EJB [%4]"
                       path="/subsystem=ejb3/message-driven-bean=*"
                       parent="Deployment,SubDeployment"
                       metricSets="Message Driven EJB Metrics" />

    <resource-type-dmr name="Stateless Session EJB [%4]"
                       path="/subsystem=ejb3/stateless-session-bean=*"
                       parent="Deployment,SubDeployment"
                       metricSets="Stateless Session EJB Metrics" />
  </resource-type-set-dmr>

  <managed-servers>
    <remote-dmr name="Local Host"
                enabled="true"
                host="localhost"
                port="9990"
                resourceTypeSets="Main,Deployment,Web Component,EJB" />

    <remote-dmr name="Another Remote"
                enabled="false"
                host="somehost"
                port="9990"
                username="adminUser"
                password="adminPass"
                resourceTypeSets="Main,Deployment,Web Component,EJB" />

    <local-dmr enabled="true"
               resourceTypeSets="Hawkular,Main,Deployment,Web Component,EJB" />

  </managed-servers>

  <avail-set-dmr name="Server Availability" enabled="true">
    <avail-dmr name="App Server"
               interval="30"
               timeUnits="seconds"
               path="/"
               attribute="server-state"
               upRegex="run.*" />
  </avail-set-dmr>

  <avail-set-dmr name="Deployment Status" enabled="true">
    <avail-dmr name="Deployment Status"
               interval="1"
               timeUnits="minutes"
               path="/"
               attribute="status"
               upRegex="OK" />
  </avail-set-dmr>

</subsystem>
